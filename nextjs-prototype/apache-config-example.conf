# ============================================
# Configuración Apache para Prototipo Next.js
# AseguraloCR - Acceso Público Aislado
# ============================================
#
# OPCIÓN 1: Ruta específica /prototype
# OPCIÓN 2: Subdominio prototype.aseguralocr.com
#
# Requiere módulos: proxy, proxy_http, proxy_wstunnel
# ============================================


# ────────────────────────────────────────────
# Habilitar Módulos Necesarios
# ────────────────────────────────────────────

# En Ubuntu/Debian:
# sudo a2enmod proxy
# sudo a2enmod proxy_http
# sudo a2enmod proxy_wstunnel
# sudo a2enmod ssl
# sudo systemctl restart apache2

# En cPanel: Los módulos suelen estar habilitados


# ────────────────────────────────────────────
# OPCIÓN 1: Ruta específica /prototype
# URL: https://aseguralocr.com/prototype
# ────────────────────────────────────────────

# Agregar en el VirtualHost existente de aseguralocr.com:

<IfModule mod_proxy.c>
    # Frontend Next.js
    ProxyPass /prototype http://localhost:3000
    ProxyPassReverse /prototype http://localhost:3000

    # WebSocket support para hot reload (desarrollo)
    ProxyPass /prototype/_next/webpack-hmr ws://localhost:3000/_next/webpack-hmr
    ProxyPassReverse /prototype/_next/webpack-hmr ws://localhost:3000/_next/webpack-hmr

    # Backend API
    ProxyPass /api http://localhost:3001/api
    ProxyPassReverse /api http://localhost:3001/api

    # Headers
    <Location /prototype>
        ProxyPreserveHost On
        RequestHeader set X-Forwarded-Proto "https"
        RequestHeader set X-Forwarded-Port "443"
    </Location>

    <Location /api>
        ProxyPreserveHost On
        RequestHeader set X-Forwarded-Proto "https"
    </Location>
</IfModule>


# ────────────────────────────────────────────
# OPCIÓN 2: Subdominio (RECOMENDADO)
# URL: https://prototype.aseguralocr.com
# ────────────────────────────────────────────

# Crear archivo: /etc/apache2/sites-available/prototype.aseguralocr.com.conf

<VirtualHost *:80>
    ServerName prototype.aseguralocr.com
    ServerAdmin info@aseguralocr.com

    # Redirigir a HTTPS
    Redirect permanent / https://prototype.aseguralocr.com/
</VirtualHost>

<VirtualHost *:443>
    ServerName prototype.aseguralocr.com
    ServerAdmin info@aseguralocr.com

    # SSL Configuration (Let's Encrypt)
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/prototype.aseguralocr.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/prototype.aseguralocr.com/privkey.pem

    # Logs separados
    ErrorLog ${APACHE_LOG_DIR}/prototype.aseguralocr.com-error.log
    CustomLog ${APACHE_LOG_DIR}/prototype.aseguralocr.com-access.log combined

    # Proxy Configuration
    <IfModule mod_proxy.c>
        ProxyPreserveHost On
        ProxyRequests Off

        # Frontend Next.js (puerto 3000)
        ProxyPass / http://localhost:3000/
        ProxyPassReverse / http://localhost:3000/

        # WebSocket support
        ProxyPass /_next/webpack-hmr ws://localhost:3000/_next/webpack-hmr
        ProxyPassReverse /_next/webpack-hmr ws://localhost:3000/_next/webpack-hmr

        # Backend API (puerto 3001)
        ProxyPass /api http://localhost:3001/api
        ProxyPassReverse /api http://localhost:3001/api

        # Headers para proxy
        RequestHeader set X-Forwarded-Proto "https"
        RequestHeader set X-Forwarded-Port "443"
        RequestHeader set X-Real-IP %{REMOTE_ADDR}s
    </IfModule>

    # Timeouts
    ProxyTimeout 300
    Timeout 300

    # Security Headers
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"

    # Cache para assets estáticos de Next.js
    <LocationMatch "/_next/static/">
        Header set Cache-Control "public, max-age=31536000, immutable"
    </LocationMatch>
</VirtualHost>


# ────────────────────────────────────────────
# Pasos para Activar (OPCIÓN 2)
# ────────────────────────────────────────────

# 1. Copiar archivo:
#    sudo cp apache-config-example.conf /etc/apache2/sites-available/prototype.aseguralocr.com.conf

# 2. Habilitar sitio:
#    sudo a2ensite prototype.aseguralocr.com

# 3. Crear DNS A record:
#    prototype.aseguralocr.com -> IP del servidor

# 4. Obtener certificado SSL:
#    sudo certbot --apache -d prototype.aseguralocr.com

# 5. Test configuración:
#    sudo apachectl configtest

# 6. Recargar Apache:
#    sudo systemctl reload apache2

# 7. Verificar:
#    curl https://prototype.aseguralocr.com/api/health


# ────────────────────────────────────────────
# Para cPanel
# ────────────────────────────────────────────

# 1. Ir a cPanel → "Dominios" → "Crear un Nuevo Dominio"
#    - Dominio: prototype.aseguralocr.com
#    - Document Root: /home/usuario/public_html/nextjs-prototype

# 2. Editar .htaccess en /home/usuario/public_html/nextjs-prototype/.htaccess:

<IfModule mod_rewrite.c>
    RewriteEngine On

    # Proxy a Next.js (puerto 3000)
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^(.*)$ http://localhost:3000/$1 [P,L]

    # Proxy API a Express (puerto 3001)
    RewriteRule ^api/(.*)$ http://localhost:3001/api/$1 [P,L]
</IfModule>

# 3. Habilitar SSL en cPanel → "SSL/TLS" → Let's Encrypt


# ────────────────────────────────────────────
# Troubleshooting
# ────────────────────────────────────────────

# Error: "Service Unavailable" o "502 Bad Gateway"
# → Verificar que PM2 está corriendo:
#   pm2 list

# Error: "Connection refused"
# → Verificar puertos:
#   netstat -tlnp | grep -E '3000|3001'

# Error: "Proxy Error"
# → Verificar logs:
#   tail -f /var/log/apache2/error.log

# Verificar proxy Apache:
#   sudo apachectl -M | grep proxy

